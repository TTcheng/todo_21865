<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>待办事项管理</title>
    <script>document.write('\<script src="../js/includeJs.js?r=' + Math.random() + '"\>\<\/script\>');</script>
    <script>document.write('\<script src="' + basePath + '/js/includeCss.js?v=' + localVersion + '"\>\<\/script\>');</script>
    <script>document.write('\<script src="' + basePath + '/js/jquery.easyui.min.js?v=' + localVersion + '"\>\<\/script\>');</script>
    <!--easyui css-->
    <script>document.write('\<link href="' + basePath + '/css/easyui/demo.css?v=' + localVersion + '" rel="stylesheet" />');</script>
    <script>document.write('\<link href="' + basePath + '/css/easyui/easyui.css?v=' + localVersion + '" rel="stylesheet" />');</script>
    <script>document.write('\<link href="' + basePath + '/css/easyui/icon.css?v=' + localVersion + '" rel="stylesheet" />');</script>
    <style>
        .top-btn {
            position: relative;
            margin-bottom: 10px;
            height: 30px;
            line-height: 30px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-static-top navbar-default">
    <div class="container-fluid">
        <div>
            <div class="navbar-header">
                <div class="navbar-brand">
                    <span id="logo"></span>
                </div>
                <span class="navbar-brand">个人待办事项管理系统</span>
            </div>
        </div>
    </div>
</nav>
<div style="margin:20px 0;"></div>

<table id="dg" title="待办列表" style="width:700px;height:300px" data-options="
				rownumbers:true,
				singleSelect:true,
				autoRowHeight:false,
				pagination:true,
				pageSize:10">
    <thead>
    <tr>
        <th field="todo_no" width="80">序号</th>
        <th field="todo_title" width="100">标题</th>
        <th field="todo_content" width="80">内容</th>
        <th field="todo_prior" width="80" align="right">优先级</th>
        <th field="todo_creation_date" width="80" align="right">创建时间</th>
        <th field="todo_update_date" width="100" align="right">更新时间</th>
        <th field="todo_comment" width="110">备注</th>
    </tr>
    </thead>
</table>
</body>

<!--自定义配置部分-->
<script>
    (function ($) {
        function pagerFilter(data) {
            if ($.isArray(data)) {	// is array
                data = {
                    total: data.length,
                    rows: data
                }
            }
            var target = this;
            var dg = $(target);
            var state = dg.data('datagrid');
            var opts = dg.datagrid('options');
            if (!state.allRows) {
                state.allRows = (data.rows);
            }
            if (!opts.remoteSort && opts.sortName) {
                var names = opts.sortName.split(',');
                var orders = opts.sortOrder.split(',');
                state.allRows.sort(function (r1, r2) {
                    var r = 0;
                    for (var i = 0; i < names.length; i++) {
                        var sn = names[i];
                        var so = orders[i];
                        var col = $(target).datagrid('getColumnOption', sn);
                        var sortFunc = col.sorter || function (a, b) {
                            return a == b ? 0 : (a > b ? 1 : -1);
                        };
                        r = sortFunc(r1[sn], r2[sn]) * (so == 'asc' ? 1 : -1);
                        if (r != 0) {
                            return r;
                        }
                    }
                    return r;
                });
            }
            var start = (opts.pageNumber - 1) * parseInt(opts.pageSize);
            var end = start + parseInt(opts.pageSize);
            data.rows = state.allRows.slice(start, end);
            return data;
        }

        var loadDataMethod = $.fn.datagrid.methods.loadData;
        var deleteRowMethod = $.fn.datagrid.methods.deleteRow;
        $.extend($.fn.datagrid.methods, {
            clientPaging: function (jq) {
                return jq.each(function () {
                    var dg = $(this);
                    var state = dg.data('datagrid');
                    var opts = state.options;
                    opts.loadFilter = pagerFilter;
                    var onBeforeLoad = opts.onBeforeLoad;
                    opts.onBeforeLoad = function (param) {
                        state.allRows = null;
                        return onBeforeLoad.call(this, param);
                    }
                    var pager = dg.datagrid('getPager');
                    pager.pagination({
                        onSelectPage: function (pageNum, pageSize) {
                            opts.pageNumber = pageNum;
                            opts.pageSize = pageSize;
                            pager.pagination('refresh', {
                                pageNumber: pageNum,
                                pageSize: pageSize
                            });
                            dg.datagrid('loadData', state.allRows);
                        }
                    });
                    $(this).datagrid('loadData', state.data);
                    if (opts.url) {
                        $(this).datagrid('reload');
                    }
                });
            },
            loadData: function (jq, data) {
                jq.each(function () {
                    $(this).data('datagrid').allRows = null;
                });
                return loadDataMethod.call($.fn.datagrid.methods, jq, data);
            },
            deleteRow: function (jq, index) {
                return jq.each(function () {
                    var row = $(this).datagrid('getRows')[index];
                    deleteRowMethod.call($.fn.datagrid.methods, $(this), index);
                    var state = $(this).data('datagrid');
                    if (state.options.loadFilter == pagerFilter) {
                        for (var i = 0; i < state.allRows.length; i++) {
                            if (state.allRows[i] == row) {
                                state.allRows.splice(i, 1);
                                break;
                            }
                        }
                        $(this).datagrid('loadData', state.allRows);
                    }
                });
            },
            getAllRows: function (jq) {
                return jq.data('datagrid').allRows;
            }
        })
    })(jQuery);

    /**
     * 获取数据
     * @returns {Array}
     */
    function getData() {
        var rows = [];
        loading('open','加载中...');
        $.ajax({
            url:basePath+'/todo/queryPageList',
            type:'post',
            async:false,
            data:{
                begin:1,
                end:10
                // todo 获取Session获取用户信息
            },
            dataType:'json',
            success:function (res) {
                if (res.status ==='success'){
                    var data = res.data;
                    for (var i = 0; i < data.length; i++) {
                        var item  = data[i];
                        rows.push({
                            todo_no: item.todoItemId,
                            todo_title: item.todoItemTitle,
                            todo_content: item.todoItemContent,
                            todo_prior: item.priority,
                            todo_creation_date: item.creationDate,
                            todo_update_date: item.lastUpdateDate,
                            todo_comment: item.comments
                        });
                    }
                }
            },
            error:function () {
                alert('请求失败！');
            },
            complete:function () {
                loading('close');
            }
        });

        return rows;
    }

    $(function () {
        $('#dg').datagrid({data: getData()}).datagrid('clientPaging');
    });
</script>
</html>